name: "Composite action attempt 1"
description: "Try to get this composite action to run in a private repo"

inputs:
  SERVER_URL:
    description: 'The url of your docassemble server. This should be in your github SECRETS or the SECRETS of your org.'
    required: true
  PLAYGROUND_EMAIL:
    description: 'The email of your docassemble testing account. This should be in your github SECRETS or the SECRETS of your org.'
    required: true
  PLAYGROUND_PASSWORD:
    description: 'The password of your docassemble testing account. This should be in your github SECRETS or the SECRETS of your org.'
    required: true
  PLAYGROUND_ID:
    description: 'The id of your docassemble testing account. This should be in your github SECRETS or the SECRETS of your org.'
    required: true
  EXTRA_LANGUAGES:
    description: 'Other languages you want to test. This should be in your github SECRETS or the SECRETS of your org.'
    required: true
    default: ''
    # TODO: Check if we really need the `if` for extra languages

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v1
      with:
        node-version: "12"
    - run: npm install
      shell: bash

    # Run all the node commands. `env:` vars only exist inside the specific `run:`
    - name: "ALKiln: Run tests"
      env:
        REPO_URL: "${{ github.server_url }}/${{ github.repository }}"
        BRANCH_PATH: ${{ github.ref }}
        BASE_URL: ${{ inputs.SERVER_URL }}
        PLAYGROUND_EMAIL: ${{ inputs.PLAYGROUND_EMAIL }}
        PLAYGROUND_PASSWORD: ${{ inputs.PLAYGROUND_PASSWORD }}
        PLAYGROUND_ID: ${{ inputs.PLAYGROUND_ID }}
        EXTRA_LANGUAGES: ${{ inputs.EXTRA_LANGUAGES }}
      run: |
        echo -e "\nRepo is $REPO_URL\nBranch is $BRANCH_PATH\n"
        npm run setup && npm run test -- ${{ github.event.inputs.tags && format('"--tags" "{0}"', github.event.inputs.tags) }}; npm run takedown
      shell: bash

    # Artifacts users can download on the Actions summary page
    - name: "ALKiln: Upload errors to action summary artifacts"
      if: ${{ failure() }}
      uses: actions/upload-artifact@v2
      with:
        name: errors
        path: ./**/error*.jpg
    - name: "ALKiln: Upload screenshots to action summary artifacts"
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: screenshots
        path: ./**/screenshot*.jpg
    - name: "ALKiln: Upload downloaded files to action summary artifacts"
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: downloads
        path: ./**/downloads_*
    - name: "ALKiln: Upload report to action summary artifacts"
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: report
        path: ./**/*_report_*
